version: 3

normalization:
  numbers:
    strip_currency: true
    decimal_comma_to_dot: true

  area:
    unit: "sqm"

  floor:
    drop_tokens: ["этаж", "эт", "э."]
    map_special:
      basement: ["подвал", "-1"]
      socle: ["цоколь"]
      mezzanine: ["мезонин"]
    multi:
      enabled: true
      split_separators: [",", ";", "/", " и ", "&"]
      range_separators: ["-", "–"]
      render:
        join_token: "; "
        range_dash: "-"
        sort_numeric_first: true
        uniq: true

  use_type:
    canon: ["офис", "ритейл", "псн", "склад"]
    synonyms:
      "офис": ["office", "open space", "офис open space", "open-space", "кабинетная", "офисный", "студия", "смешанная"]
      "ритейл": ["retail", "street-retail", "street retail", "стрит-ритейл", "торговая", "торговое"]
      "псн": ["свободного назначения"]
      "склад": ["storage", "warehouse", "складское"]



  fitout_condition:
    canon: ["с отделкой", "под отделку"]
    synonyms:
      "с отделкой": ["с готовым ремонтом", "готово к въезду", "с мебелью", "есть отделка", "Выполнен ремонт", "Полностью готово к", "гипсовые перегородки", "за выездом арендатора"]
      "под отделку": ["white box", "готово к отделке"]

  dates:
    ru_months:
      январь: 01; февраль: 02; март: 03; апрель: 04; май: 05; июнь: 06
      июль: 07; август: 08; сентябрь: 09; октябрь: 10; ноябрь: 11; декабрь: 12
    quarters:
      Q1: "03-31"; Q2: "06-30"; Q3: "09-30"; Q4: "12-31"
    now_tokens:
      - сейчас
      - свободно
      - готово к въезду
      - сегодня
  vat:
    canon: ["включен", "не включен", "не применяется"]
    synonyms:
      "не применяется": ["УСН", "УСН, без НДС", "освобождено", "не облагается НДС", "НДС 5%", "без НДС (УСН)", "УСН без НДС"]
      "включен": ["включая НДС", "с НДС", "НДС включен", "ставка с НДС", "вкл. НДС", "с учетом НДС", "НДС по действующей ставке"]
      "не включен": ["без НДС", "без НДС.", "без учета НДС", "НДС не включен", "не включая НДС", "начисляется НДС"]
    default_rate: 0.20

  opex_included:
    canon: ["включен", "не включен"]
    synonyms:
      "включен": ["включая эксплуатационные услуги", "opex включен", "включены", "коммунальные платежи"]
      "не включен": ["opex не включен", "отдельно"]

  opex:
    default_included: false
    default_year_per_sqm: null

matching:
  area_tolerance:
    abs_sqm: 2
    rel_pct: 2.0
  # детерминированный join-key для листинга
  join_key_listing:
    parts: ["object_id", "building_token", "use_type_norm", "floors_norm", "area_1dp"]

derivation:
  rent_rate_year_sqm_base:
    priority: ["direct", "reconstruct_from_month"]
    reconstruct_from_month:
      respect_vat: true
      respect_opex: true
      vat_fallback: 0.20
      round_decimals: 2
  gross_month_total:
    round_decimals: 2

quality:
  outliers:
    rent_rate_year_sqm_base:
      min: 1000
      max: 200000

fallbacks:
  rent_vat_norm:
    use_listing_vat: true
    use_object_rent_vat: true
  use_type_norm:
    default: офис
  market_type:
    by_fitout:
      с отделкой: ранее арендованное
      под отделку: новое
  divisible_from_sqm:
    copy_from: area_sqm
  opex_included:
    set_when_year_per_sqm_present: "не включен"
  vat_partial_synonyms:
    "включен": ["НДС по действующей ставке"]
    не включен: начисляется НДС


questions:
  fitout_condition: "Уточните отделку: «с отделкой» или «под отделку»?"
  delivery_date: "Уточните дату передачи (ISO YYYY-MM-DD) или «сейчас»."
  use_type: "Уточните тип использования: офис, торговое, псн или склад."

# Имя здания и ID строятся на уровне листинга (без агрегаций)
naming:
  building:
    name_compose: "{object_name}{suffix}"       # suffix = ", {building_token}" если он есть
    id_compose: "{object_id}__{building_token_slug}"  # если токена нет — просто object_id

identifier:
  # Уникальный и стабильный ID листинга (по нормализованным полям + короткий хэш)
  listing_id:
    compose_parts: ["object_id", "building_token_slug", "use_type_norm_slug", "floors_norm_slug", "area_1dp"]
    hash_part: ["source_file_basename"]  # включаем имя источника для уникальности при похожих блоках
    hash_len: 8
    join_token: "__"

output:
  # КОЛОНКИ ВЫХОДНОЙ EXCEL-ТАБЛИЦЫ (КАЖДОЕ ПОМЕЩЕНИЕ = 1 СТРОКА)
  listing_columns:
    - building_name|Здание
    - use_type_norm|Тип использования
    - area_sqm|Площадь, кв.м.
    - divisible_from_sqm|Делится от, кв.м.
    - floors_norm|Этаж
    - market_type|Новый / Вторичка
    - fitout_condition_norm|Состояние помещения
    - delivery_date_norm|Дата передачи
    - rent_rate_year_sqm_base|Ставка аренды в год за кв.м., руб.
    - rent_vat_norm|НДС (ставка аренды)
    - opex_year_per_sqm|OPEX в год за кв.м., руб.
    - opex_included|OPEX включен
    - rent_month_total_gross|Ставка аренды в месяц, руб.
    - sale_price_per_sqm|Цена продажи за кв.м., руб.
    - sale_vat_norm|НДС (цена продажи)
    - source_file|Исходный файл
    - recognition_summary|Сводка распознавания
    - uncertain_parameters|Сомнительные параметры

pipeline:
  common:
    pdf_conversion:
      enabled: true
      engine: libreoffice
    agentql:
      enabled: true
      mode: standard
      timeout_sec: 600
  doc:
    doc_to_md:
      enabled: true
      to_format: gfm
    chatgpt_structured:
      enabled: true
  excel:
    excel_to_csv:
      enabled: true
    chatgpt_structured:
      enabled: true
  docx:
    docx_to_md:
      enabled: true
      to_format: gfm
    chatgpt_structured:
      enabled: true
  ppt:
    ppt_to_md:
      enabled: true
      heading_prefix: "# "
      bullet_prefix: "- "
      include_tables: true
    chatgpt_structured:
      enabled: true
  pdf:
    pdf_to_images:
      enabled: true
      dpi: 250
      format: png
      poppler_path: "C:\\Program Files\\Poppler\\Library\\bin"
    vision_per_page:
      enabled: true
    chatgpt_structured:
      enabled: true
  image:
    pdf_conversion:
      enabled: true
      engine: img2pdf
    agentql:
      enabled: true
  txt:
    pdf_conversion:
      enabled: true
    agentql:
      enabled: true
  audio:
    transcription:
      enabled: true
      provider: app-audio
      timeout_sec: 300
      language: auto
      model: whisper-large-v3
    chatgpt_structured:
      enabled: true
      model: gpt-5
  postprocess:
    excel_export:
      enabled: true
      format: xlsx
