# Telegram бот: приём файлов → ответ Excel

Проект на базе Aiogram 3 и FastAPI. Поддерживает два режима работы:
- локально через long-polling;
- прод в режиме вебхука (`/webhook`).

## Переменные окружения
- `BOT_TOKEN` — токен Telegram-бота (обязательно).
- `MICROSERVICE_BASE_URL` — базовый URL микросервиса обработки файлов (обязательно). Endpoint `/process_file` принимает `multipart/form-data` с полями `file` и `chat_id` и возвращает XLSX.
- `WEBHOOK_URL` — публичный HTTPS‑URL вебхука, например `https://example.com/webhook`. Используется в режиме вебхука (на старте бот вызывает `setWebhook`).
- `MAX_FILE_MB` — лимит размера входного файла в мегабайтах. По умолчанию `20`.
- `MICROSERVICE_CONNECT_TIMEOUT` — (опционально) таймаут установления соединения с микросервисом, секунды (по умолчанию `60`).
- `MICROSERVICE_READ_TIMEOUT` — (опционально) таймаут ожидания ответа микросервиса, секунды (по умолчанию `300`).
- (опционально для запуска `python -m app.main`) `HOST`, `PORT`, `RELOAD` — хост/порт/авторелоад Uvicorn. По умолчанию: `0.0.0.0`, `8080`, `0`.

Все переменные можно задать через `.env` в корне проекта — файл подхватывается автоматически.

Пример `.env`:
```
BOT_TOKEN=123456:ABC...
MICROSERVICE_BASE_URL=http://127.0.0.1:8000
WEBHOOK_URL=https://your-domain.com/webhook
MAX_FILE_MB=20
MICROSERVICE_READ_TIMEOUT=360  # пример увеличенного ожидания
```

## Локальный запуск (polling)
1. Создайте виртуальное окружение и установите зависимости:
   ```bash
   python -m venv .venv
   # Linux/macOS
   source .venv/bin/activate
   # Windows PowerShell
   .venv\Scripts\Activate.ps1
   pip install -r requirements.txt
   ```
2. Настройте `.env` (минимум `BOT_TOKEN`, `MICROSERVICE_BASE_URL`).
3. Запустите поллинг-раннер:
   ```bash
   python -m app.polling_runner
   ```
Бот будет писать логи в stdout. Поддерживаются файлы PDF/DOCX/PPTX/XLSX/JPG/PNG и аудио WAV/MP3/M4A/OGG/AAC до 20 МБ.

## Запуск с вебхуком
Нужен публичный HTTPS и настроенный `WEBHOOK_URL`.

Примеры команд:
- Uvicorn напрямую:
  ```bash
  uvicorn app.main:app --host 0.0.0.0 --port 8080
  ```
- Через модуль (учитывает `HOST`/`PORT`/`RELOAD` из `.env`):
  ```bash
  python -m app.main
  ```
- Прод-режим (Gunicorn + Uvicorn workers):
  ```bash
  gunicorn -k uvicorn.workers.UvicornWorker app.main:app --bind 0.0.0.0:8080 --timeout 60
  ```

При старте настраивается `setWebhook`. Telegram присылает POST на `/webhook`.

## Поведение при получении файлов
- Все входящие файлы/фото/аудио скачиваются во временный каталог `data/uploads`.
- Голосовые и аудио‑сообщения сохраняются как файлы и также отправляются в микросервис.
- После обработки временные файлы удаляются.

## Ограничения и ответы бота
- Лимит размера — 20 МБ (настраивается `MAX_FILE_MB`).
- Сообщения пользователю:
  - при превышении лимита: «Файл слишком большой (максимум 20 МБ)»;
  - при сетевой/серверной ошибке микросервиса: «Не удалось обработать файл, попробуйте позже».
- Логи фиксируют ключевые этапы: загрузка, отправка в микросервис, получение ответа, ошибки.

## Сценарий обработки
1. Пользователь отправляет файл (PDF/DOCX/PPTX/XLSX/JPG/PNG/WAV/MP3/M4A/OGG/AAC) до 20 МБ.
2. Бот проверяет тип и размер:
   - если это аудио — принимает WAV/MP3/M4A/OGG/AAC и отправляет в микросервис;
   - если файл > 20 МБ — отвечает об ограничении.
3. При корректном файле бот скачивает его и отвечает «Файл получен, обрабатываю…».
4. Файл отправляется в микросервис `app-ms` на `/process_file` (передаются `file` и `chat_id`).
5. При успехе бот возвращает Excel с подписью «✅ Готово: сводная таблица».
6. При ошибке сети/микросервиса — сообщение «Не удалось обработать файл, попробуйте позже».
7. Временные файлы удаляются.

## Маршруты FastAPI
- `POST /webhook` — принимаем обновления Telegram.
- `GET /healthz` — проверка живости (для мониторинга).

## Структура проекта (важное)
- `app/main.py` — FastAPI-приложение и вебхук.
- `app/polling_runner.py` — запуск long-polling.
- `app/handlers/` — хэндлеры Aiogram (документы, фото, аудио, команды).
- `app/services/ms_client.py` — асинхронный HTTP-клиент микросервиса (поддерживает настройку таймаутов).
- `app/utils/files.py` — утилиты по файлам и ограничениям.

## Микросервис обработки (`app-ms`)
- Основная документация: `app-ms/README.md`.
- Кратко: принимает загруженные файлы, конвертирует в PDF при необходимости, вытаскивает данные (AgentQL/ChatGPT), нормализует и возвращает Excel/JSON.
- Основной эндпоинт: `POST /process_file` (multipart: `file`, опции `output`, `request_id`). Дополнительно `GET /healthz`, `GET /version`.
